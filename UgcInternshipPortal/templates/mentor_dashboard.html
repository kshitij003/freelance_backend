{% extends "base.html" %}

{% block title %}Mentor Dashboard - UGC Portal{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Mentor Dashboard</h2>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>

        <div class="alert alert-info">
            <strong>Review Queue:</strong> Submissions with low-confidence extractions or partial equivalency
        </div>

        {% if submissions %}
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Student Name</th>
                        <th>Organization</th>
                        <th>Decision</th>
                        <th>WMD Score</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in submissions %}
                    <tr>
                        <td>{{ sub.timestamp[:19] }}</td>
                        <td>{{ sub.form_data.name }}</td>
                        <td>{{ sub.form_data.organization }}</td>
                        <td>
                            <span class="badge 
                                {% if sub.decision == 'Equivalent' %}bg-success
                                {% elif sub.decision == 'Partially Equivalent' %}bg-warning
                                {% else %}bg-danger{% endif %}">
                                {{ sub.decision }}
                            </span>
                        </td>
                        <td>{{ "%.2f"|format(sub.wmd_composite) }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" 
                                    onclick="reviewSubmission('{{ sub.internship_id }}')">
                                Review
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-success">
            <strong>All clear!</strong> No submissions currently require review.
        </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="reviewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Review Submission</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="reviewContent">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="pushToABC()">Push to ABC</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentInternshipId = null;

async function logout() {
    await fetch('https://freelance-backend-y0el.onrender.com/api/mentor/logout', {method: 'POST'});
    window.location.href = '/mentor';
}

async function reviewSubmission(internshipId) {
    currentInternshipId = internshipId;
    
    const response = await fetch(`https://freelance-backend-y0el.onrender.com/api/internship/${internshipId}`);
    const data = await response.json();
    
    let html = '<h6>Student Information</h6>';
    html += `<p><strong>Name:</strong> ${data.form_data.name}<br>`;
    html += `<strong>Organization:</strong> ${data.form_data.organization}<br>`;
    html += `<strong>Title:</strong> ${data.form_data.internship_title}<br>`;
    html += `<strong>Hours:</strong> ${data.form_data.hours}</p>`;
    
    html += '<h6>Evaluation</h6>';
    html += `<p><strong>Decision:</strong> ${data.decision}<br>`;
    html += `<strong>WMD Composite:</strong> ${data.wmd_composite}<br>`;
    html += `<strong>Credits:</strong> ${data.credits}</p>`;
    
    html += '<h6>Top Matches</h6><ul>';
    data.wmd_matches.slice(0, 3).forEach(match => {
        html += `<li>${match.course_id}: ${match.course_title} (${match.similarity})</li>`;
    });
    html += '</ul>';
    
    document.getElementById('reviewContent').innerHTML = html;
    new bootstrap.Modal(document.getElementById('reviewModal')).show();
}

async function pushToABC() {
    if (!currentInternshipId) return;
    
    const response = await fetch('https://freelance-backend-y0el.onrender.com/api/mentor/run_and_push', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            internship_id: currentInternshipId,
            push_to_abc: true
        })
    });
    
    const data = await response.json();
    
    if (data.success) {
        alert('Successfully pushed to ABC! Token: ' + data.record.abc_token);
        location.reload();
    } else {
        alert('Error: ' + data.error);
    }
}
</script>
{% endblock %}
